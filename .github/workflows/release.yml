name: release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to create release for'
        required: true
        type: string
      draft:
        description: 'Create as draft release'
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build-all-platforms:
    strategy:
      fail-fast: true
      matrix:
        include:
          - os: windows-latest
            platform: windows
            package_name: vulkan-visualizer-windows-x64-Release.zip
            artifact_name: windows-release
          - os: ubuntu-latest
            platform: linux
            package_name: vulkan-visualizer-linux-x64-Release.tar.gz
            artifact_name: linux-release
          - os: macos-latest
            platform: macos
            package_name: vulkan-visualizer-macos-universal-Release.tar.gz
            artifact_name: macos-release

    runs-on: ${{ matrix.os }}
    env:
      VULKAN_SDK_VERSION: latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache third-party downloads
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: deps-release-${{ runner.os }}-${{ hashFiles('CMakeLists.txt','cmake/*.cmake') }}
          restore-keys: |
            deps-release-${{ runner.os }}-
            deps-${{ runner.os }}-Release-

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential python3 git cmake ninja-build pkg-config \
            libx11-dev libxrandr-dev libxi-dev libxcursor-dev libxinerama-dev libxkbcommon-dev

      - name: Install macOS dependencies
        if: matrix.platform == 'macos'
        run: |
          brew update
          brew install cmake ninja || true

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1.2.5
        with:
          version: ${{ env.VULKAN_SDK_VERSION }}
          components: ${{ matrix.platform == 'macos' && 'Vulkan-Headers,Vulkan-Loader,MoltenVK,Glslang,SPIRV-Tools,SPIRV-Headers' || 'Vulkan-Headers,Vulkan-Loader,Glslang,SPIRV-Tools,SPIRV-Headers' }}
          cache: true
          quiet: true

      - name: Configure (Windows)
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          cmake -S . -B build -G "Ninja Multi-Config" `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON `
            -DVV_WARNINGS_AS_ERRORS=ON `
            -DCMAKE_INSTALL_PREFIX=install

      - name: Configure (Unix)
        if: matrix.platform != 'windows'
        run: |
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DVV_WARNINGS_AS_ERRORS=ON \
            -DCMAKE_INSTALL_PREFIX=install

      - name: Build Release
        run: |
          cmake --build build --config Release --parallel

      - name: Install (Windows)
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          cmake --install build --config Release --prefix install

      - name: Install (Unix)
        if: matrix.platform != 'windows'
        run: |
          cmake --install build --prefix install

      - name: Package (Windows)
        if: matrix.platform == 'windows'
        shell: powershell
        run: |
          Compress-Archive -Path install\* -DestinationPath ${{ matrix.package_name }}

      - name: Package (Unix)
        if: matrix.platform != 'windows'
        run: |
          cd install
          tar -czf ../${{ matrix.package_name }} .
          cd ..

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.package_name }}
          retention-days: 7

  create-and-upload-release:
    needs: build-all-platforms
    runs-on: ubuntu-latest
    steps:
      - name: Get version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts/

      - name: Determine if draft
        id: draft_check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "is_draft=${{ github.event.inputs.draft }}" >> $GITHUB_OUTPUT
          else
            echo "is_draft=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: VulkanVisualizer ${{ steps.get_version.outputs.version }}
          draft: ${{ steps.draft_check.outputs.is_draft }}
          prerelease: false
          generate_release_notes: true
          body: |
            ## VulkanVisualizer ${{ steps.get_version.outputs.version }}
            
            Cross-platform Vulkan rendering library with ImGui integration.
            
            ### ðŸ“¦ Downloads
            - **Windows x64**: `vulkan-visualizer-windows-x64-Release.zip`
            - **Linux x64**: `vulkan-visualizer-linux-x64-Release.tar.gz`
            - **macOS Universal**: `vulkan-visualizer-macos-universal-Release.tar.gz`
            
            ### âœ¨ Features
            - Modern Vulkan rendering engine
            - ImGui integration for debugging UI
            - VMA (Vulkan Memory Allocator) for efficient memory management
            - SDL3 for cross-platform windowing
            - Optional features: logging, GPU timestamps, tonemapping, screenshot, shader hot-reload
            
            ### ðŸ“¥ Installation
            Extract the archive for your platform. Each package includes:
            - Static library (`vulkan_visualizer.lib` or `libvulkan_visualizer.a`)
            - Public headers
            - Runtime dependencies (SDL3.dll on Windows)
            - CMake configuration files for easy integration
            
            ### ðŸ”§ Usage with CMake
            ```cmake
            find_package(VulkanVisualizer REQUIRED)
            target_link_libraries(your_target PRIVATE VulkanVisualizer::vulkan_visualizer)
            ```
            
            ### ðŸ“‹ Requirements
            - Vulkan 1.3+ compatible GPU and drivers
            - C++23 compiler
          files: |
            artifacts/windows-release/vulkan-visualizer-windows-x64-Release.zip
            artifacts/linux-release/vulkan-visualizer-linux-x64-Release.tar.gz
            artifacts/macos-release/vulkan-visualizer-macos-universal-Release.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        run: |
          echo "âœ… Release ${{ steps.get_version.outputs.version }} created successfully!"
          echo "ðŸ”— All platform packages uploaded"
